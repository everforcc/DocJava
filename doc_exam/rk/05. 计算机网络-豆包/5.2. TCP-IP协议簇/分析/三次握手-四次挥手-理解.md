<span  style="font-family: Simsun,serif; font-size: 17px; ">

# TCP 三次握手与四次挥手（通俗版笔记）

## 核心类比

用「打电话」场景类比：

- 三次握手 = 打电话建立通话（确认双方“能说能听”）；
- 四次挥手 = 挂电话结束通话（确保双方“说完所有话”）；
- 关键前提：TCP 是“全双工”—— 就像打电话时，双方能同时说话，不用等对方说完。

---

## 一、三次握手（建立连接：确认双向通信正常）

### 场景设定

- 你（客户端）：主动打电话的人；
- 朋友（服务器）：等着接电话的人（监听状态）。

### 握手流程（3步“确认”）

| 步骤  | 动作类比       | 对应 TCP 报文                                      | 通俗解读                                                                                                                  |
|-----|------------|------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------|
| 第1次 | 你拨号，等朋友接   | SYN 报文<br>`SYN=1，seq=x`                        | 你（客户端）：“喂？在吗？我想跟你聊天！”<br>（`seq=x` = 你说话的“起始序号”，相当于“我从第x个字开始说”）                                                        |
| 第2次 | 朋友接电话，回复你  | SYN+ACK 报文<br>`SYN=1，seq=y`<br>`ACK=1，ack=x+1` | 朋友（服务器）：“我在！我能听到你说话（`ACK=1` 是“回执开关”，`ack=x+1` 表示“我收到你说的x号内容，下次请从x+1开始说”）。你能听到我吗？我从第y个字开始说！”<br>（同时确认你的能力 + 发起自己的连接请求） |
| 第3次 | 你回复朋友，通话建立 | ACK 报文<br>`ACK=1，ack=y+1`                      | 你（客户端）：“我也能听到你！（`ack=y+1` 表示“我收到你说的y号内容，下次请从y+1开始说”）咱们开始聊吧！”<br>（此时双向确认完成，连接正式建立）                                     |

### 关键问题：为什么要3次？不能2次？

- 2次握手只能确认“你能说、朋友能听”，但没法确认“朋友能说、你能听”；
- 比如朋友接电话说“我能听到”，但你没收到这句话（信号差），你会一直等，而朋友也不知道你没收到，浪费资源；
- 3次握手能确保 **双向都能“说”和“听”**，没有遗漏。

---

## 二、四次挥手（释放连接：确保双方说完所有话）

### 场景设定

- 你（客户端）：先聊完，想挂电话的人；
- 朋友（服务器）：还有最后几句话没说完的人。

### 挥手流程（4步“收尾”）

| 步骤  | 动作类比              | 对应 TCP 报文                                      | 通俗解读                                                                            |
|-----|-------------------|------------------------------------------------|---------------------------------------------------------------------------------|
| 第1次 | 你说“我说完了，准备挂了”     | FIN 报文<br>`FIN=1，seq=u`                        | 你（客户端）：“我这边没要聊的了，关闭我的‘说话通道’！”<br>（此时你不能再主动说话，但还能听朋友说）                           |
| 第2次 | 朋友回复“知道了，你等我说完”   | ACK 报文<br>`ACK=1，ack=u+1`                      | 朋友（服务器）：“收到！我知道你说完了（`ack=u+1` 确认收到你的结束信号），但我还有两句话没说完，你再等我一下！”<br>（此时朋友还能说，你还能听） |
| 第3次 | 朋友说完最后两句，说“我也说完了” | FIN+ACK 报文<br>`FIN=1，seq=w`<br>`ACK=1，ack=u+1` | 朋友（服务器）：“我也说完了！我的‘说话通道’也关了，你可以挂电话了！”                                            |
| 第4次 | 你回复“好的，挂了”，等几秒再挂  | ACK 报文<br>`ACK=1，ack=w+1`                      | 你（客户端）：“收到！我这就挂！”<br>（你会等几秒再挂——对应 TCP 的 `2MSL` 等待，防止朋友没听到这句回复，还能补说一遍）           |

### 关键问题：为什么要4次？不能3次？

- TCP 是“双向通话”，“你说完”和“朋友说完”是两件独立的事，不能合并；
- 第1、2次：处理“你关闭说话通道”；第3、4次：处理“朋友关闭说话通道”；
- 要是3次挥手，会导致朋友还没说完，就被强制挂电话，丢了没说完的内容。

---

## 三、核心概念速记（避免混淆）

| 术语      | 通俗理解                                   |
|---------|----------------------------------------|
| 大写 ACK  | “回执开关”：1=打开（有回执），0=关闭（无回执）             |
| 小写 ack  | “回执内容”：只有开关打开（ACK=1）时，才表示“期望下次收到的内容序号” |
| SYN     | “连接请求信号”：相当于打电话时的“喂？”                  |
| FIN     | “结束信号”：相当于打电话时的“我说完了”                  |
| 2MSL 等待 | 挂电话前等几秒，防止最后一句没传到对方耳朵里                 |

---

## 四、软件设计师考试高频考点

1. 三次握手顺序：`SYN` → `SYN+ACK` → `ACK`（记：“喂→能听到→好的”）；
2. 四次挥手顺序：`FIN` → `ACK` → `FIN+ACK` → `ACK`（记：“我说完→知道了→我也说完→好的”）；
3. 2MSL 的作用：确保最后一个 ACK 传到对方，避免报文残留影响新连接；
4. 三次握手目的：确认双向收发能力；四次挥手目的：释放双向通道，不丢数据。

</span>