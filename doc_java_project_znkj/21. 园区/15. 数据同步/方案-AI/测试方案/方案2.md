<span  style="font-family: Simsun,serif; font-size: 17px; ">

## 方案2：物理设备无固定IP的备份方案

### 环境特点
- 云服务器：有固定公网IP，可稳定访问
- 物理设备：无固定IP（动态IP或内网IP），可能频繁变化
- 挑战：无法从云服务器主动连接到物理设备建立主从复制

### 架构设计

#### 方案2.1：云服务器主库 + 物理设备从库（推荐）

**架构拓扑**：
```
云服务器 (Master，固定IP) ←── 物理设备1 (Slave，动态IP)
                             物理设备2 (Slave，动态IP)
                             物理设备3 (Slave，动态IP)
```

**优势**：
- 物理设备主动连接云服务器，不依赖固定IP
- 云服务器作为主库，数据集中管理
- 物理设备故障不影响云服务器数据

**劣势**：
- 物理设备作为从库，只能读，不能写（或需要特殊配置）
- 如果业务必须在物理设备写入，需要额外处理

#### 方案2.2：定时同步方案（备选）

如果主从复制不可行，采用定时数据同步：
```
物理设备 → 定时导出 → 上传到云服务器 → 导入备份
```

### 方案2.1 详细配置

#### 1. 云服务器配置（主库）

**MySQL 配置**：
```ini
# /etc/my.cnf
[mysqld]
server-id = 1
log-bin = mysql-bin
binlog-format = ROW
# 允许所有IP连接（生产环境建议限制）
bind-address = 0.0.0.0
expire_logs_days = 7
max_binlog_size = 100M
```

**创建复制用户**：
```sql
-- 允许从任意IP连接（生产环境建议限制IP段）
CREATE USER 'repl'@'%' IDENTIFIED BY 'strong_password_here';
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';
FLUSH PRIVILEGES;

-- 查看主库状态
SHOW MASTER STATUS;
-- 记录 File 和 Position
```

**防火墙配置**：
```bash
# 开放 MySQL 端口（默认3306）
firewall-cmd --permanent --add-port=3306/tcp
firewall-cmd --reload

# 或使用 iptables
iptables -A INPUT -p tcp --dport 3306 -j ACCEPT
```

#### 2. 物理设备配置（从库）

**MySQL 配置**：
```ini
# /etc/my.cnf
[mysqld]
server-id = 2  # 每台设备使用不同ID
relay-log = mysql-relay-bin
read-only = 1  # 从库只读（如果业务需要写，设为0）
replicate-do-db = your_database
# 自动重连配置
master-reconnect-retries = 60
master-connect-retry = 10
```

**建立主从关系**：
```sql
-- 配置主从关系（物理设备主动连接云服务器）
CHANGE MASTER TO
  MASTER_HOST='云服务器固定IP',
  MASTER_PORT=3306,
  MASTER_USER='repl',
  MASTER_PASSWORD='strong_password_here',
  MASTER_LOG_FILE='mysql-bin.000001',
  MASTER_LOG_POS=154,
  MASTER_CONNECT_RETRY=10,
  MASTER_RETRY_COUNT=60;

-- 启动从库复制
START SLAVE;

-- 查看从库状态
SHOW SLAVE STATUS\G
-- 确认 Slave_IO_Running 和 Slave_SQL_Running 都是 Yes
```

#### 3. 自动重连脚本

由于物理设备IP可能变化，需要确保网络恢复后自动重连：

```bash
#!/bin/bash
# 自动重连脚本 auto_reconnect.sh

CLOUD_IP="云服务器固定IP"
MYSQL_USER="root"
MYSQL_PASS="password"

# 检查从库状态
check_slave() {
  STATUS=$(mysql -u$MYSQL_USER -p$MYSQL_PASS -e "SHOW SLAVE STATUS\G" 2>/dev/null | \
    grep -E "Slave_IO_Running|Slave_SQL_Running" | awk '{print $2}')
  
  IO_RUNNING=$(echo $STATUS | awk '{print $1}')
  SQL_RUNNING=$(echo $STATUS | awk '{print $2}')
  
  if [ "$IO_RUNNING" != "Yes" ] || [ "$SQL_RUNNING" != "Yes" ]; then
    return 1
  fi
  return 0
}

# 测试网络连通性
test_network() {
  ping -c 1 -W 2 $CLOUD_IP > /dev/null 2>&1
  return $?
}

# 重启从库复制
restart_slave() {
  mysql -u$MYSQL_USER -p$MYSQL_PASS <<EOF
  STOP SLAVE;
  START SLAVE;
EOF
}

# 主循环
while true; do
  if ! test_network; then
    echo "$(date): Network unreachable, waiting..."
    sleep 30
    continue
  fi
  
  if ! check_slave; then
    echo "$(date): Slave not running, restarting..."
    restart_slave
    sleep 10
  else
    echo "$(date): Slave running normally"
  fi
  
  sleep 60  # 每分钟检查一次
done
```

**配置为系统服务**：
```bash
# /etc/systemd/system/mysql-reconnect.service
[Unit]
Description=MySQL Replication Auto Reconnect
After=mysql.service

[Service]
Type=simple
ExecStart=/path/to/auto_reconnect.sh
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target

# 启动服务
systemctl enable mysql-reconnect
systemctl start mysql-reconnect
```

### 方案2.2 定时同步方案（备选）

如果主从复制不可行，使用定时数据同步：

#### 1. 物理设备导出脚本

```bash
#!/bin/bash
# 物理设备数据导出脚本 export_data.sh

BACKUP_DIR="/tmp/mysql_backup"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="your_database"
MYSQL_USER="backup_user"
MYSQL_PASS="backup_password"
CLOUD_IP="云服务器固定IP"
CLOUD_USER="ssh_user"
CLOUD_BACKUP_DIR="/backup/mysql/from_physical"

# 创建临时备份目录
mkdir -p $BACKUP_DIR

# 导出数据
mysqldump -u$MYSQL_USER -p$MYSQL_PASS \
  --single-transaction \
  --routines \
  --triggers \
  --events \
  --master-data=2 \
  $DB_NAME | gzip > $BACKUP_DIR/backup_$DATE.sql.gz

# 上传到云服务器（使用 scp）
scp -i /path/to/ssh_key \
  $BACKUP_DIR/backup_$DATE.sql.gz \
  $CLOUD_USER@$CLOUD_IP:$CLOUD_BACKUP_DIR/

# 清理本地临时文件
rm -f $BACKUP_DIR/backup_$DATE.sql.gz

echo "Export completed: backup_$DATE.sql.gz"
```

#### 2. 云服务器导入脚本

```bash
#!/bin/bash
# 云服务器数据导入脚本 import_data.sh

BACKUP_DIR="/backup/mysql/from_physical"
DB_NAME="your_database"
MYSQL_USER="root"
MYSQL_PASS="password"

# 查找最新的备份文件
LATEST_BACKUP=$(ls -t $BACKUP_DIR/*.sql.gz | head -1)

if [ -z "$LATEST_BACKUP" ]; then
  echo "No backup file found!"
  exit 1
fi

echo "Importing: $LATEST_BACKUP"

# 导入数据（先备份现有数据）
mysqldump -u$MYSQL_USER -p$MYSQL_PASS $DB_NAME | \
  gzip > /backup/mysql/before_import_$(date +%Y%m%d_%H%M%S).sql.gz

# 导入新数据
gunzip -c $LATEST_BACKUP | mysql -u$MYSQL_USER -p$MYSQL_PASS $DB_NAME

echo "Import completed"
```

#### 3. 定时任务配置

**物理设备（crontab）**：
```bash
# 每6小时同步一次
0 */6 * * * /path/to/export_data.sh >> /var/log/mysql_sync.log 2>&1
```

**云服务器（crontab）**：
```bash
# 每6小时导入一次（在物理设备导出后）
10 */6 * * * /path/to/import_data.sh >> /var/log/mysql_import.log 2>&1
```

### 方案2.3 VPN隧道方案（高级）

如果物理设备可以通过VPN连接到云服务器：

#### 1. 建立VPN连接

**使用 WireGuard 或 OpenVPN**：
```bash
# 物理设备配置VPN客户端
# 连接到云服务器VPN服务器
# 获得虚拟IP，例如：10.0.0.2
```

#### 2. 使用VPN IP建立主从

```sql
-- 物理设备配置主从（使用VPN IP）
CHANGE MASTER TO
  MASTER_HOST='10.0.0.1',  -- 云服务器VPN IP
  MASTER_USER='repl',
  MASTER_PASSWORD='password',
  MASTER_LOG_FILE='mysql-bin.000001',
  MASTER_LOG_POS=154;

START SLAVE;
```

### 监控与告警

#### 1. 从库连接状态监控（云服务器端）

```bash
#!/bin/bash
# 监控所有从库连接状态 monitor_slaves.sh

MYSQL_USER="monitor"
MYSQL_PASS="monitor_pass"

# 查看所有连接的从库
mysql -u$MYSQL_USER -p$MYSQL_PASS -e "
SELECT 
  SUBSTRING_INDEX(HOST, ':', 1) as slave_ip,
  COUNT(*) as connections
FROM information_schema.PROCESSLIST
WHERE COMMAND = 'Binlog Dump'
GROUP BY slave_ip;
" | while read slave_ip connections; do
  if [ "$slave_ip" != "slave_ip" ]; then
    echo "Slave connected: $slave_ip ($connections connections)"
  fi
done
```

#### 2. 物理设备同步延迟监控

```bash
#!/bin/bash
# 物理设备监控脚本 check_sync.sh

MYSQL_USER="monitor"
MYSQL_PASS="monitor_pass"
ALERT_LAG=300  # 延迟超过5分钟告警

LAG=$(mysql -u$MYSQL_USER -p$MYSQL_PASS -e "SHOW SLAVE STATUS\G" | \
  grep "Seconds_Behind_Master" | awk '{print $2}')

if [ "$LAG" = "NULL" ] || [ -z "$LAG" ]; then
  echo "ERROR: Replication is broken!"
  # 发送告警
elif [ "$LAG" -gt "$ALERT_LAG" ]; then
  echo "WARNING: Replication lag is $LAG seconds"
  # 发送告警
fi
```

### 恢复方案

#### 1. 物理设备恢复（从云服务器）

```bash
#!/bin/bash
# 物理设备恢复脚本 restore_from_cloud.sh

CLOUD_IP="云服务器固定IP"
BACKUP_DATE=$1  # 格式：20240101_020000
DB_NAME="your_database"
MYSQL_USER="root"
MYSQL_PASS="password"

# 从云服务器下载备份
scp -i /path/to/ssh_key \
  user@$CLOUD_IP:/backup/mysql/$BACKUP_DATE/full_backup_$BACKUP_DATE.sql.gz \
  /tmp/

# 恢复数据
gunzip -c /tmp/full_backup_$BACKUP_DATE.sql.gz | \
  mysql -u$MYSQL_USER -p$MYSQL_PASS $DB_NAME

# 重新建立主从关系
mysql -u$MYSQL_USER -p$MYSQL_PASS <<EOF
STOP SLAVE;
RESET SLAVE ALL;

CHANGE MASTER TO
  MASTER_HOST='$CLOUD_IP',
  MASTER_USER='repl',
  MASTER_PASSWORD='repl_password',
  MASTER_LOG_FILE='从云服务器获取最新binlog文件',
  MASTER_LOG_POS=从云服务器获取最新binlog位置;

START SLAVE;
EOF

echo "Restore completed!"
```

### 注意事项

1. **网络安全**：
   - 使用强密码
   - 限制复制用户IP范围（如果可能）
   - 考虑使用SSL加密连接

2. **网络稳定性**：
   - 物理设备网络可能不稳定，需要自动重连机制
   - 监控网络延迟，避免影响业务

3. **数据一致性**：
   - 如果物理设备需要写入，考虑使用双主模式或应用层路由
   - 定期检查数据一致性

4. **备份策略**：
   - 云服务器作为主库，定期全量备份
   - 物理设备作为从库，可选择性备份

5. **故障处理**：
   - 物理设备故障时，云服务器数据完整
   - 物理设备恢复后，从云服务器同步最新数据

### 方案对比

| 方案 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| 方案2.1 主从复制 | 实时同步、自动化 | 需要网络稳定 | 网络相对稳定 |
| 方案2.2 定时同步 | 不依赖持续连接 | 有延迟、可能丢失数据 | 网络不稳定、可接受延迟 |
| 方案2.3 VPN隧道 | 稳定连接、安全 | 需要VPN基础设施 | 有VPN环境 |

### 推荐方案

**首选**：方案2.1（主从复制）+ 自动重连机制
- 实时同步，数据丢失风险低
- 配置自动重连脚本应对网络波动
- 云服务器作为主库，数据集中管理

**备选**：方案2.2（定时同步）
- 如果网络极不稳定，无法维持持续连接
- 可接受一定数据延迟的场景

</span>

