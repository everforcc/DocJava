<span  style="font-family: Simsun,serif; font-size: 17px; ">

# CameraDataCount 定时任务性能优化建议

## 问题分析

### 1. 事务范围过大（最严重）

**问题**：整个方法在一个事务中，导致数据库连接长时间占用
**影响**：如果某个 group 处理很慢，会阻塞整个事务，导致数据延迟入库

### 2. N+1 查询问题

**问题**：每条统计记录都要查询一次历史记录
**影响**：如果统计记录很多，会产生大量数据库查询

### 3. 循环中的重复查询

**问题**：在循环中执行数据库查询
**影响**：增加数据库压力

### 4. 时间范围限制

**问题**：只查询当天的数据
**影响**：如果任务延迟，可能无法补统计历史数据

### 5. 数据库索引缺失

**问题**：关键查询可能缺少索引
**影响**：查询速度慢

## 优化方案

### 方案1：拆分事务（推荐）

将事务范围缩小到每个 group 的处理，而不是整个方法

### 方案2：批量查询历史记录

将 N+1 查询改为批量查询，一次性获取所有需要的历史记录

### 3. 优化时间范围查询

移除当天限制，改为查询最近 N 条记录或按时间范围查询

### 4. 添加数据库索引

为关键查询添加合适的索引

### 5. 优化循环查询

减少循环中的数据库查询次数


</span>