<span  style="font-family: Simsun,serif; font-size: 17px; ">

### **Volatile的理解**

- 该关键字可以确保对一个变量的更新对其他线程马上可见。
- 当一个变量被声明为volatile时，线程在写入变量时不会把值缓存在寄存器或者其他地方，而是会把值刷新回主内存。
- 当其他线程读取该共享变量时－，会从主内存重新获取最新值，而不是使用当前线程的工作内存中的值。
- volatile的内存语义和synchronized有相似之处，具体来说就是，当线程写入了volatile变量值时就等价于线程退出synchronized同步块（把写入工作内存的变量值同步到主内存），
- 读取volatile变量值时就相当于进入同步块（先清空本地内存变量值，再从主内存获取最新值）。
- 不能保证原子性

### 为什么volatile只用来保证变量可见性，但不保证原子性

- [参考](https://www.zhihu.com/question/329746124)
- 简单的说，修改volatile变量分为四步：

1. 读取volatile变量到local
2. 修改变量值
3. local值写回
4. 插入内存屏障，即lock指令，让其他线程可见

- 这样就很容易看出来，前三步都是不安全的，取值和写回之间，不能保证没有其他线程修改。
- 原子性需要锁来保证。
- 这也就是为什么，volatile只用来保证变量可见性，但不保证原子性。

</span>