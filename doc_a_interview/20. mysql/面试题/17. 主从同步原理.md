<span  style="font-family: Simsun,serif; font-size: 17px; ">

[TOC]

- 主从同步
- 主要涉及到三个线程
    - m: master（binlog dump thread）
    - s: slave（I/O threa）
    - s: sql（thread）

### 异步同步

- 主节点binlog，主从复制的基础是主库记录数据库的所有变更记录到binlog，binlog是数据库服务器启动的那一刻起，保存所有修改数据库结构或内容的一个文件
- 主节点log dump线程，当binlog有变动时，log dump 线程读取其内容并发送给从节点。
- 从节点I/O 线程接收binlog内容，并将其写入到 relay log 文件中
- 从节点的sql线程读取 repay log 文件内容对数据更新进行重放，保证数据库的一致性
- 主节点使用bbinlog文件+position偏移量来定位主从同步的位置，从节点会保存其已接收到的偏移量
    - 如果从节点发生宕机重启，会自动从 position的位置发起同步
- 由于mysql默认的复制方式是异步的，主库吧日志发送给从库后不关心从库是否已经处理，这样会导致假设主库挂了，从库处理失败
- 从库升级为主库后，日志丢失


### 全同步复制

- 主库写入binlog后强制同步日志到从库，所有的从库都执行完后才返回给客户端
- 显然这个方式的话性能会收到影响

### 半同步复制

- 和全同步不同的是，半同步复制的逻辑是这样的，从库写入日志成功后返回ACK确认给主库
- 主库收到至少一个从库的确认就认为操作完成

</span>